{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="text-center">Premium Membership</h4>
            </div>
            <div class="card-body">
                {% if is_premium %}
                <div class="text-center py-4">
                    <i class="bi bi-patch-check-fill text-warning" style="font-size: 4rem;"></i>
                    <h3 class="mt-3">You're a Premium Member!</h3>
                    <p class="lead">Thank you for supporting Mood Journal</p>

                    <div class="card mt-4">
                        <div class="card-body">
                            <h5>Your Premium Benefits:</h5>
                            <ul class="text-start">
                                <li>✓ Unlimited journal entries</li>
                                <li>✓ Advanced mood insights</li>
                                <li>✓ Export your data</li>
                                <li>✓ Priority support</li>
                                <li>✓ Early access to new features</li>
                            </ul>
                        </div>
                    </div>

                    <a href="{{ url_for('dashboard') }}" class="btn btn-primary mt-4">
                        <i class="bi bi-speedometer2 me-2"></i>Go to Dashboard
                    </a>
                </div>
                {% else %}
                <div class="text-center">
                    <h3>Unlock Premium Features</h3>
                    <p class="lead">Take your mood tracking to the next level</p>
                </div>

                <div class="row mt-4">
                    <!-- Free Plan -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5>Free Plan</h5>
                                <h2 class="text-primary">KES 0<span class="text-muted">/month</span></h2>
                                <ul class="list-unstyled text-start">
                                    <li>✓ 5 journal entries</li>
                                    <li>✓ Basic mood tracking</li>
                                    <li>✓ Simple charts</li>
                                    <li>✗ Limited insights</li>
                                    <li>✗ No data export</li>
                                </ul>
                                <button class="btn btn-outline-secondary w-100" disabled>Current Plan</button>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Premium -->
                    <div class="col-md-4">
                        <div class="card h-100 border-warning">
                            <div class="card-body text-center position-relative">
                                <div class="badge bg-warning text-dark position-absolute top-0 end-0 m-2">Popular</div>
                                <h5>Monthly Premium</h5>
                                <h2 class="text-warning">KES 1000<span class="text-muted">/month</span></h2>
                                <ul class="list-unstyled text-start">
                                    <li>✓ Unlimited journal entries</li>
                                    <li>✓ Advanced mood tracking</li>
                                    <li>✓ Detailed charts</li>
                                    <li>✓ Deep insights</li>
                                    <li>✓ Data export</li>
                                </ul>
                                <button class="btn btn-warning w-100 pay-btn" data-plan="monthly" data-amount="1000">
                                    Upgrade Now
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Annual Premium -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5>Annual Premium</h5>
                                <h2 class="text-success">KES 10000<span class="text-muted">/year</span></h2>
                                <ul class="list-unstyled text-start">
                                    <li>✓ Everything in Monthly</li>
                                    <li>✓ 2 months free</li>
                                    <li>✓ Priority support</li>
                                    <li>✓ Early feature access</li>
                                    <li>✓ Special discounts</li>
                                </ul>
                                <button class="btn btn-success w-100 pay-btn" data-plan="annual" data-amount="10000">
                                    Upgrade Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="bi bi-shield-check me-2"></i>
                    Payments are securely processed by Paystack. We don't store your payment information.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Paystack Script -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const payButtons = document.querySelectorAll('.pay-btn');

    payButtons.forEach(button => {
        button.addEventListener('click', async function () {
            const plan = this.dataset.plan;
            let amount = parseFloat(this.dataset.amount);

            if (!amount || isNaN(amount) || amount <= 0) {
                alert('Invalid amount. Please try again.');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const res = await fetch('/initiate-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, plan })
                });

                const data = await res.json();

                if (!data.status) {
                    alert('Payment failed: ' + data.message);
                    button.disabled = false;
                    button.innerHTML = 'Upgrade Now';
                    return;
                }
console.log("Backend amount:", data.data.amount);
console.log("Currency being sent:", "KES");
                console.log("Paystack Key:", "{{ paystack_key }}");
                console.log("User Email:", "{{ current_user.email }}");

                const handler = PaystackPop.setup({
                    key: "{{ paystack_key|safe }}",      // must be pk_test_xxx
                    email: "{{ current_user.email }}",   // must be valid
                    amount: data.data.amount,            // already multiplied by 100 in backend
                    currency: "KES",
                    ref: data.data.reference,
                    callback: function(response) {
                        window.location.href = `/verify-payment?reference=${response.reference}`;
                    },
                    onClose: function() {
                        button.disabled = false;
                        button.innerHTML = "Upgrade Now";
                    }
                });

                handler.openIframe();

            } catch (err) {
                console.error(err);
                alert('An error occurred. Please try again.');
                button.disabled = false;
                button.innerHTML = 'Upgrade Now';
            }
        });
    });
});
</script>
{% endblock %}
